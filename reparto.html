<script>
    const ably = new Ably.Realtime({ key: 'DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA' });
    const canal = ably.channels.get('canal-operativo-menu');

    let misRutas = JSON.parse(localStorage.getItem('p_reparto_activos')) || [];
    let choferActual = localStorage.getItem('chofer_nombre') || "";
    // FONDO DE DINERO: Recuperar cu√°nto dinero lleva en la bolsa
    let dineroEnBolsa = parseFloat(localStorage.getItem('dinero_bolsa')) || 0;

    function actualizarBolsa() {
        const panel = document.getElementById('info-dinero');
        panel.innerText = `Llevas: $${dineroEnBolsa.toFixed(2)}`;
        
        // ALERTA DE SEGURIDAD: L√≠mite 1500
        if(dineroEnBolsa >= 1500) {
            panel.className = "alert alert-danger fw-bold text-center animate__animated animate__flash infinite";
            panel.innerHTML = `üö® L√çMITE EXCEDIDO ($${dineroEnBolsa})<br>REGRESA A BASE A DEJAR DINERO`;
        } else {
            panel.className = "alert alert-dark text-center fw-bold";
        }
    }

    function entregado(id) {
        const p = misRutas.find(x => x.id == id);
        
        // Sumar al acumulado si el pago fue en efectivo
        if(p.pago === "Efectivo") {
            dineroEnBolsa += parseFloat(p.total);
            localStorage.setItem('dinero_bolsa', dineroEnBolsa);
        }

        // Avisar a Despacho y Gerente
        canal.publish('status-' + id, { estado: 'entregado' });
        canal.publish('venta-finalizada', p);
        // Avisar cu√°nto dinero llevamos (para que Despacho sepa)
        canal.publish('reporte-bolsa', { chofer: choferActual, total: dineroEnBolsa });

        misRutas = misRutas.filter(x => x.id != id);
        localStorage.setItem('p_reparto_activos', JSON.stringify(misRutas));
        document.getElementById(`r-${id}`).remove();
        actualizarBolsa();
    }

    // Bot√≥n para cuando el repartidor entrega el dinero en caja
    function liquidarCaja() {
        if(confirm("¬øYa entregaste el dinero en caja?")) {
            dineroEnBolsa = 0;
            localStorage.setItem('dinero_bolsa', 0);
            canal.publish('reporte-bolsa', { chofer: choferActual, total: 0 });
            actualizarBolsa();
        }
    }
</script>

<div id="info-dinero" class="alert alert-dark text-center fw-bold">Llevas: $0</div>
<button class="btn btn-sm btn-outline-secondary w-100 mb-3" onclick="liquidarCaja()">Limpiar Bolsa (Entregu√© dinero)</button>
