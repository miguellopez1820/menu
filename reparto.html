<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Reparto Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        body { background: #1a1a1a; color: #fff; }
        .corte-alerta { background: #ff3b30; color: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 4px solid #fff; }
        .card-repa { background: #fff; color: #000; border-radius: 15px; border-left: 8px solid #06C167; }
    </style>
</head>
<body class="p-3">
    <div id="login" class="text-center py-5">
        <h2 class="mb-4 fw-bold text-success">REPARTO DASH</h2>
        <div class="d-grid gap-3">
            <button class="btn btn-outline-light py-3" onclick="entrar('Juan')">JUAN üõµ</button>
            <button class="btn btn-outline-light py-3" onclick="entrar('Pedro')">PEDRO üõµ</button>
        </div>
    </div>

    <div id="app" class="d-none">
        <div id="corte-msg" class="corte-alerta d-none">
            <h4 class="fw-bold m-0">üö® L√çMITE DE $1,900</h4>
            <small>Termina tus rutas y al volver deja $1,500 en caja. Conserva tus $400.</small>
            <button class="btn btn-light btn-sm w-100 mt-2 fw-bold" onclick="dejarDinero()">YA DEJ√â LOS $1,500 ‚úÖ</button>
        </div>
        <div class="bg-success text-dark p-3 rounded-4 mb-4 d-flex justify-content-between align-items-center">
            <div><small class="fw-bold">DINERO (FONDO+VENTA)</small><h2 class="m-0 fw-bold" id="bolsa-txt">$400.00</h2></div>
            <div class="text-end"><small>HISTORIAL</small><h2 class="m-0 fw-bold" id="cnt-h">0</h2></div>
        </div>
        <div id="lista-reparto"></div>
        <hr class="border-secondary">
        <div id="mini-hist" class="small text-white-50"></div>
    </div>

<script>
    const ably = new Ably.Realtime('DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA');
    const canal = ably.channels.get('pedidos-dash');
    let miNombre = ""; let miDinero = parseFloat(localStorage.getItem('r_dinero')) || 400;
    let misActivos = JSON.parse(localStorage.getItem('r_activos')) || [];
    let miHistorial = JSON.parse(localStorage.getItem('r_hist')) || [];

    function entrar(n) {
        miNombre = n; document.getElementById('login').classList.add('d-none');
        document.getElementById('app').classList.remove('d-none');
        actualizarUI();
        canal.subscribe('asignado-' + n, (m) => {
            if(misActivos.find(x => x.id == m.data.id)) return;
            misActivos.push(m.data); localStorage.setItem('r_activos', JSON.stringify(misActivos));
            actualizarUI();
        });
    }

    function actualizarUI() {
        document.getElementById('bolsa-txt').innerText = `$${miDinero}.00`;
        document.getElementById('cnt-h').innerText = miHistorial.length;
        document.getElementById('corte-msg').classList.toggle('d-none', miDinero < 1900);
        const cont = document.getElementById('lista-reparto'); cont.innerHTML = "";
        misActivos.forEach(p => {
            const div = document.createElement('div'); div.className = "card-repa p-3 mb-3 shadow-lg";
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-dark">#${p.folio}</span>
                    <h4 class="text-danger fw-bold m-0">$${p.total}</h4>
                </div>
                <div class="small fw-bold mb-2 text-uppercase">üìç ${p.direccion}</div>
                ${p.pago === 'Tarjeta' ? '<div class="badge bg-primary w-100 mb-2 p-2 fw-bold">üí≥ RECORDAR TERMINAL</div>' : ''}
                <div class="d-grid gap-2">
                    <button class="btn btn-primary fw-bold" onclick="ir('${p.id}','${p.folio}','${p.gps}')">üìç MAPA</button>
                    <button class="btn btn-success fw-bold" onclick="entregar('${p.id}')">ENTREGADO ‚úÖ</button>
                </div>`;
            cont.appendChild(div);
        });
    }

    function ir(id, folio, gps) {
        canal.publish('rastreo-repa', { repartidor: miNombre, estado: 'Entregando', folio: folio });
        window.open(gps, '_blank');
    }

    function entregar(id) {
        const p = misActivos.find(x => x.id == id);
        miDinero += parseFloat(p.total); miHistorial.push(p.folio);
        misActivos = misActivos.filter(x => x.id != id);
        localStorage.setItem('r_dinero', miDinero);
        localStorage.setItem('r_activos', JSON.stringify(misActivos));
        localStorage.setItem('r_hist', JSON.stringify(miHistorial));
        canal.publish('para-gerente', p);
        canal.publish('status-' + id, { estado: 'entregado' });
        canal.publish('rastreo-repa', { repartidor: miNombre, estado: 'Regresando', folio: '---' });
        if(miDinero >= 1900) canal.publish('alerta-recaudacion', { repartidor: miNombre, total: miDinero });
        actualizarUI();
    }

    function dejarDinero() {
        if(confirm("Confirmas entrega de $1,500?")) {
            miDinero = 400; localStorage.setItem('r_dinero', 400); actualizarUI();
        }
    }
</script>
</body>
</html>
