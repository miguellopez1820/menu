<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>COCINA 1 | CENAS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        body { background: #1a1a1a; color: white; font-family: 'Arial Black', sans-serif; overflow-x: hidden; }
        .header-cocina { background: #FF6600; color: white; padding: 20px; text-align: center; border-bottom: 10px solid #cc5200; }
        .ticket-cocina { background: white; color: black; border-radius: 30px; margin-bottom: 25px; border-top: 15px solid #FF6600; box-shadow: 0 10px 20px rgba(0,0,0,0.5); position: relative; }
        .folio-txt { font-size: 6rem; font-weight: 900; line-height: 1; color: #1a1a1a; }
        .pedido-detalle { font-size: 3.5rem; line-height: 1.1; font-weight: 800; border-top: 4px solid #eee; padding-top: 15px; }
        .nota-alerta { background: #ffff00; color: #d32f2f; font-size: 3rem; padding: 20px; border-radius: 15px; border: 6px solid #d32f2f; margin-top: 20px; text-align: center; animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        .btn-listo { font-size: 2.5rem; padding: 20px; border-radius: 20px; font-weight: 900; text-transform: uppercase; }
        .retraso { border: 15px solid #ff0000 !important; } /* Alerta si pasa el tiempo */
    </style>
</head>
<body class="p-3">
    <div class="header-cocina mb-4">
        <h1 class="display-1 fw-bold">üî• COCINA 1: CENAS</h1>
    </div>

    <div id="lista-pedidos" class="row g-4"></div>

    <audio id="campana" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
    const ably = new Ably.Realtime({ key: 'YOUR_ABLY_KEY' });
    const canal = ably.channels.get('canal-operativo-menu');
    
    canal.subscribe('nuevo-pedido', (m) => {
        const p = m.data;
        // FILTRO: Solo si trae alimentos (Cenas)
        if (p.alimentos && p.alimentos.trim() !== "") {
            document.getElementById('campana').play();
            dibujarTicket(p);
        }
    });

    // Escuchar cancelaciones
    canal.subscribe('cancelar-global', m => {
        document.getElementById('t-' + m.data.id)?.remove();
    });

    function dibujarTicket(p) {
        const div = document.createElement('div');
        div.id = `t-${p.id}`;
        div.className = "col-xl-4 col-lg-6";
        
        // Timer para marcar retraso a los 15 min
        const inicio = Date.now();
        setInterval(() => {
            if ((Date.now() - inicio) > 900000) { // 15 minutos
                document.getElementById('card-'+p.id).classList.add('retraso');
            }
        }, 60000);

        div.innerHTML = `
            <div class="ticket-cocina p-4" id="card-${p.id}">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="folio-txt">#${p.folio}</span>
                    <span class="badge bg-dark fs-4">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                </div>
                <div class="pedido-detalle">
                    ${p.alimentos.replace(/\n/g, '<br>')}
                </div>
                ${p.notas ? `<div class="nota-alerta">‚ö†Ô∏è ${p.notas.toUpperCase()}</div>` : ''}
                <button class="btn btn-success btn-listo w-100 mt-4" onclick="listo('${p.id}')">PEDIDO LISTO ‚úÖ</button>
            </div>`;
        document.getElementById('lista-pedidos').prepend(div);
    }

    function listo(id) {
        // Al dar listo, avisamos que el pedido ya no est√° en cocina
        document.getElementById('t-' + id).remove();
        canal.publish('status-' + id, { estado: 'preparado' });
    }
</script>
</body>
</html>
