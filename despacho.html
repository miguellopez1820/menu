<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Despacho</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
</head>
<body class="bg-light p-4">
    <h2 class="fw-bold mb-4">ðŸ“¦ Centro de Control</h2>
    <div id="lista" class="row"></div>
<script>
    const ably = new Ably.Realtime('DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA');
    const canal = ably.channels.get('pedidos-dash');
    let folio = parseInt(localStorage.getItem('f_dash')) || 1;
    let pendientes = [];

    canal.subscribe('nuevo', (m) => {
        const p = m.data; p.folio = folio++; localStorage.setItem('f_dash', folio);
        pendientes.push(p);
        canal.publish('update-folio', { id: p.id, folio: p.folio });
        canal.publish('status-'+p.id, { folio: p.folio });
        
        const div = document.createElement('div'); div.id = `d-${p.id}`; div.className = "col-4 mb-3";
        div.innerHTML = `<div class="card p-3 shadow-sm border-primary">
            <h5>Folio #${p.folio}</h5>
            <pre class="small">${p.alimentos}${p.snacks}</pre>
            <div id="st-Alimentos-${p.id}" class="badge bg-secondary mb-1">C1: Esperando</div>
            <div id="st-Snacks-${p.id}" class="badge bg-secondary mb-3">C2: Esperando</div>
            ${!p.presencial ? `<select id="sel-${p.id}" class="form-select mb-2"><option value="Juan">Juan</option><option value="Pedro">Pedro</option></select>
            <button class="btn btn-primary w-100" onclick="enviar('${p.id}')">DESPACHAR</button>` : `<button class="btn btn-dark w-100" onclick="entregarLocal('${p.id}')">ENTREGAR EN LOCAL</button>`}
        </div>`;
        document.getElementById('lista').prepend(div);
    });

    canal.subscribe('cocina-lista', (m) => {
        const el = document.getElementById(`st-${m.data.area}-${m.data.id}`);
        if(el) { el.className = "badge bg-success mb-1"; el.innerText = m.data.area + ": LISTO"; }
    });

    function enviar(id){
        const p = pendientes.find(x => x.id == id); const r = document.getElementById('sel-'+id).value;
        p.repartidor = r; canal.publish('asignado-'+r, p);
        canal.publish('status-'+id, { estado: 'camino' });
        document.getElementById('d-'+id).remove();
    }
    function entregarLocal(id){
        canal.publish('para-gerente', pendientes.find(x => x.id == id));
        document.getElementById('d-'+id).remove();
    }
</script>
</body>
</html>
