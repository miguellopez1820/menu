<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Despacho | Taquer√≠a Leo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
</head>
<body class="bg-light p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold m-0">üì¶ CENTRAL DE DESPACHO</h2>
        <div id="repa-monitor" class="d-flex gap-2"></div>
    </div>
    <div id="lista" class="row g-3"></div>

<script>
    const ably = new Ably.Realtime({ key: 'DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA' });
    const canal = ably.channels.get('canal-operativo-menu');
    let activos = JSON.parse(localStorage.getItem('d_activos')) || [];
    let folios = parseInt(localStorage.getItem('f_num')) || 1;
    let saldos = {};

    activos.forEach(p => dibujar(p));

    canal.subscribe('nuevo-pedido', m => {
        const p = m.data;
        if(activos.find(x => x.id == p.id)) return;
        p.folio = folios++;
        localStorage.setItem('f_num', folios);
        activos.push(p);
        save();
        canal.publish('folio-asignado', { id: p.id, folio: p.folio });
        dibujar(p);
    });

    canal.subscribe('reporte-bolsa', m => { saldos[m.data.chofer] = m.data.total; updateRepas(); });

    function dibujar(p) {
        const div = document.createElement('div'); div.id = `c-${p.id}`; div.className = "col-md-6 col-lg-4";
        div.innerHTML = `
            <div class="card p-3 shadow-sm border-start border-primary border-5">
                <div class="d-flex justify-content-between mb-2">
                    <span class="h4 fw-bold">#${p.folio}</span>
                    <span class="badge ${p.presencial?'bg-dark':'bg-primary'}">${p.presencial?'LOCAL':'DOM'}</span>
                </div>
                <pre class="bg-light p-2 small fw-bold">${p.alimentos}${p.snacks}</pre>
                <p class="small text-muted mb-3">üìç ${p.direccion}</p>
                <div class="d-flex gap-2">
                    ${p.presencial ? 
                        `<button class="btn btn-success btn-sm w-100 fw-bold" onclick="finalizar('${p.id}','entregado')">COBRAR</button>` :
                        `<select id="re-${p.id}" class="form-select form-select-sm"><option value="Juan">Juan</option><option value="Pedro">Pedro</option></select>
                         <button class="btn btn-primary btn-sm" onclick="enviarRepa('${p.id}')">ENVIAR</button>`
                    }
                    <button class="btn btn-outline-danger btn-sm" onclick="cancelar('${p.id}')">‚úï</button>
                </div>
            </div>`;
        document.getElementById('lista').prepend(div);
    }

    function cancelar(id) {
        if(prompt("CLAVE GERENTE:") === "LEO2026") {
            canal.publish('cancelar-global', { id });
            finalizar(id, 'cancelado');
        }
    }

    function enviarRepa(id) {
        const repa = document.getElementById('re-'+id).value;
        if(saldos[repa] >= 1500) return alert("Repartidor bloqueado por exceso de efectivo.");
        const p = activos.find(x => x.id == id);
        p.chofer_nombre = repa;
        canal.publish('asignado-' + repa, p);
        canal.publish('status-' + id, { estado: 'en camino' });
        finalizar(id, 'despachado');
    }

    function finalizar(id, st) {
        const p = activos.find(x => x.id == id);
        p.status = st;
        if(st !== 'despachado') {
            p.horaFin = Date.now();
            canal.publish('registro-gerente', p);
        }
        activos = activos.filter(x => x.id != id);
        save();
        document.getElementById(`c-${id}`).remove();
    }
    function save() { localStorage.setItem('d_activos', JSON.stringify(activos)); }
    function updateRepas() { 
        const m = document.getElementById('repa-monitor'); m.innerHTML = "";
        for(let r in saldos) m.innerHTML += `<span class="badge ${saldos[r]>=1500?'bg-danger':'bg-dark'} m-1">${r}: $${saldos[r]}</span>`;
    }
</script>
</body>
</html>
