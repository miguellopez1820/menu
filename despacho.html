<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Despacho Maestro - Blindado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
</head>
<body class="bg-light p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">ðŸ“¦ MONITOR DE DESPACHO</h2>
        <div id="status-conexion" class="badge bg-success">CONECTADO</div>
    </div>
    <div id="lista" class="row g-3"></div>

<script>
    const ably = new Ably.Realtime({ key: 'DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA', recover: true });
    const canal = ably.channels.get('canal-operativo-menu');
    
    // CARGA INICIAL ANTI-REFRESCO
    let pedidosActivos = JSON.parse(localStorage.getItem('p_activos_despacho')) || [];
    let folioContador = parseInt(localStorage.getItem('f_num')) || 1;

    // Dibujar lo que ya estaba en memoria
    pedidosActivos.forEach(p => dibujarPedido(p));

    canal.subscribe('nuevo-pedido', (m) => {
        const p = m.data;
        if(pedidosActivos.find(x => x.id == p.id)) return; // Evita duplicados

        p.folio = folioContador++;
        localStorage.setItem('f_num', folioContador);

        pedidosActivos.push(p);
        localStorage.setItem('p_activos_despacho', JSON.stringify(pedidosActivos));

        canal.publish('folio-asignado', { id: p.id, folio: p.folio });
        dibujarPedido(p);
    });

    function dibujarPedido(p) {
        const div = document.createElement('div');
        div.id = `d-${p.id}`;
        div.className = "col-md-4 mb-3";
        div.innerHTML = `
            <div class="card p-3 shadow-sm border-primary">
                <h4 class="fw-bold">#${p.folio} - ${p.nombre}</h4>
                <pre style="font-size: 1.1rem; white-space: pre-wrap;">${p.alimentos || ''}${p.snacks || ''}</pre>
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="cambiarStatus('${p.id}', 'en camino')">ðŸšš EN CAMINO</button>
                    <button class="btn btn-dark" onclick="finalizar('${p.id}')">ENTREGADO âœ…</button>
                </div>
            </div>`;
        document.getElementById('lista').prepend(div);
    }

    function cambiarStatus(id, estado) {
        canal.publish('status-' + id, { estado: estado });
        alert("Cliente notificado: " + estado);
    }

    function finalizar(id) {
        // Notificamos al cliente para que su web se limpie pronto
        canal.publish('status-' + id, { estado: 'entregado' });
        
        pedidosActivos = pedidosActivos.filter(x => x.id != id);
        localStorage.setItem('p_activos_despacho', JSON.stringify(pedidosActivos));
        document.getElementById(`d-${id}`).remove();
    }
</script>
</body>
</html>
