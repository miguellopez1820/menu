<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Despacho Central</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        body { background: #f4f7f6; font-family: sans-serif; }
        .pedido-card { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-left: 8px solid #0d6efd; }
    </style>
</head>
<body class="p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ðŸ“¦ MONITOR DE DESPACHO</h2>
        <div id="bolsas-repas" class="d-flex gap-2"></div>
    </div>
    <div id="lista" class="row g-3"></div>

<script>
    const ably = new Ably.Realtime({ key: 'DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA', recover: true });
    const canal = ably.channels.get('canal-operativo-menu');
    
    let pedidosActivos = JSON.parse(localStorage.getItem('p_despacho')) || [];
    let folioContador = parseInt(localStorage.getItem('f_num')) || 1;
    let estadosBolsa = {};

    pedidosActivos.forEach(p => dibujar(p));

    canal.subscribe('nuevo-pedido', (m) => {
        const p = m.data;
        if(pedidosActivos.find(x => x.id == p.id)) return;
        p.folio = folioContador++;
        localStorage.setItem('f_num', folioContador);
        pedidosActivos.push(p);
        localStorage.setItem('p_despacho', JSON.stringify(pedidosActivos));
        canal.publish('folio-asignado', { id: p.id, folio: p.folio });
        dibujar(p);
    });

    canal.subscribe('reporte-bolsa', (m) => {
        estadosBolsa[m.data.chofer] = m.data.total;
        renderBolsas();
    });

    function renderBolsas() {
        const cont = document.getElementById('bolsas-repas');
        cont.innerHTML = "";
        for(let c in estadosBolsa) {
            const alerta = estadosBolsa[c] >= 1500 ? 'bg-danger' : 'bg-dark';
            cont.innerHTML += `<span class="badge ${alerta}">${c}: $${estadosBolsa[c]}</span>`;
        }
    }

    function dibujar(p) {
        const div = document.createElement('div');
        div.id = `d-${p.id}`;
        div.className = "col-md-6 col-lg-4 mb-3";
        div.innerHTML = `
            <div class="pedido-card p-3">
                <h4>#${p.folio} - ${p.nombre}</h4>
                <div class="bg-light p-2 mb-2 small text-uppercase fw-bold">${p.alimentos || ''}${p.snacks || ''}</div>
                <p class="small mb-2">${p.direccion || 'LOCAL'}</p>
                ${p.presencial ? 
                    `<button class="btn btn-dark w-100" onclick="finalizar('${p.id}')">ENTREGAR LOCAL âœ…</button>` :
                    `<select id="repa-${p.id}" class="form-select mb-2"><option value="Juan">Juan</option><option value="Pedro">Pedro</option></select>
                     <button class="btn btn-primary w-100" onclick="enviarRuta('${p.id}')">ASIGNAR REPARTO</button>`
                }
            </div>`;
        document.getElementById('lista').prepend(div);
    }

    function enviarRuta(id) {
        const repa = document.getElementById('repa-'+id).value;
        if(estadosBolsa[repa] >= 1500) return alert("REPARTIDOR BLOQUEADO: Debe regresar a dejar efectivo.");
        const p = pedidosActivos.find(x => x.id == id);
        canal.publish('asignado-' + repa, p);
        canal.publish('status-' + id, { estado: 'en camino' });
        finalizar(id);
    }

    function finalizar(id) {
        const p = pedidosActivos.find(x => x.id == id);
        if(p.presencial) canal.publish('venta-finalizada', p);
        pedidosActivos = pedidosActivos.filter(x => x.id != id);
        localStorage.setItem('p_despacho', JSON.stringify(pedidosActivos));
        document.getElementById(`d-${id}`).remove();
    }
</script>
</body>
</html>
