<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dash Food - Ordenar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        :root { --main: #06C167; }
        body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; padding-bottom: 200px; }
        .product-card { background: #fff; border-radius: 15px; padding: 12px; margin-bottom: 8px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .btn-qty { width: 32px; height: 32px; border-radius: 8px; border: 1px solid #ddd; background: #fff; font-weight: bold; }
        .cart-footer { background: #fff; position: fixed; bottom: 0; width: 100%; max-width: 500px; padding: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); border-radius: 25px 25px 0 0; left: 50%; transform: translateX(-50%); z-index: 100; }
        .btn-confirm { background: var(--main); color: #fff; border: none; border-radius: 12px; padding: 15px; width: 100%; font-weight: bold; }
        .step { padding-left: 35px; margin-bottom: 15px; position: relative; color: #ccc; }
        .step.active { color: #000; font-weight: bold; }
        .dot { position: absolute; left: 0; width: 22px; height: 22px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; }
        .active .dot { background: var(--main); color: white; }
    </style>
</head>
<body class="d-flex justify-content-center">
    <div style="width: 100%; max-width: 500px;">
        <div id="pantalla-menu">
            <div class="p-4 bg-dark text-white text-center rounded-bottom shadow">
                <h2 class="fw-bold mb-0">Dash Food üçî</h2>
                <div class="badge bg-success mt-2 p-2">‚è≥ Promedio de entrega: <span id="tiempo-promo">45 - 55</span> MIN</div>
            </div>
            <div id="contenedor-menu" class="p-3"></div>
            <div class="p-3 bg-white mx-3 rounded-4 shadow-sm mb-3">
                <input type="text" id="nombre" class="form-control mb-2" placeholder="Tu nombre">
                <textarea id="direccion" class="form-control mb-3" placeholder="Direcci√≥n y referencias"></textarea>
                <h6 class="fw-bold">M√©todo de Pago:</h6>
                <div class="d-flex gap-2">
                    <input type="radio" class="btn-check" name="pago" id="p_ef" value="Efectivo" checked>
                    <label class="btn btn-outline-dark w-100" for="p_ef">üíµ Efectivo</label>
                    <input type="radio" class="btn-check" name="pago" id="p_tar" value="Tarjeta">
                    <label class="btn btn-outline-dark w-100" for="p_tar">üí≥ Tarjeta</label>
                </div>
            </div>
            <div class="cart-footer">
                <div id="desglose" class="small text-muted mb-1 text-center"></div>
                <div class="d-flex justify-content-between mb-3 px-1"><b>Total:</b> <b id="total-txt" class="text-success fs-5">$0.00</b></div>
                <button id="btn-ordenar" onclick="enviarPedido()" class="btn-confirm shadow">ORDENAR AHORA</button>
            </div>
        </div>

        <div id="pantalla-tracking" class="p-4 d-none text-center">
            <div class="alert alert-success border-0 shadow-sm mb-4 rounded-4">
                <h6 class="mb-1 opacity-75">Tiempo estimado:</h6>
                <h3 class="fw-bold m-0"><span id="t-final-tracking">45-55</span> MIN</h3>
            </div>
            <h2 class="fw-bold">Orden #<span id="folio-display">--</span></h2>
            <div class="text-start mt-4 px-3">
                <div id="st-1" class="step active"><div class="dot">1</div> Recibido ‚úÖ</div>
                <div id="st-2" class="step"><div class="dot">2</div> En Cocina üî•</div>
                <div id="st-3" class="step"><div class="dot">3</div> En Camino üõµ</div>
                <div id="st-4" class="step"><div class="dot">4</div> Entregado üèÅ</div>
            </div>
            <a href="https://wa.me/523316275115" target="_blank" class="btn btn-outline-success w-100 mt-4 py-3 fw-bold rounded-4">Ayuda WhatsApp üí¨</a>
        </div>
    </div>

<script>
    const ably = new Ably.Realtime('DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA');
    const canal = ably.channels.get('pedidos-dash');

    const menuData = [
        { cat: "Alimentos", area: "Alimentos", items: [{id:"h1", nom:"Hawaiana", pre:135}, {id:"h2", nom:"BBQ Mango", pre:160}, {id:"t1", nom:"Tacos", pre:120}]},
        { cat: "Snacks", area: "Snacks", items: [{id:"a1", nom:"Alitas BBQ", pre:160}, {id:"b1", nom:"Bionico", pre:65}]}
    ];

    let carrito = {}; let total = 0; let envio = 15;
    const cont = document.getElementById('contenedor-menu');
    menuData.forEach(s => {
        cont.innerHTML += `<div class="badge bg-dark mb-2 text-uppercase">${s.cat}</div>`;
        s.items.forEach(p => {
            cont.innerHTML += `<div class="product-card"><div><b>${p.nom}</b><br><small>$${p.pre}</small></div><div class="d-flex align-items-center gap-2"><button class="btn-qty" onclick="updateQty('${p.id}',-1,${p.pre},'${p.nom}')">-</button><b id="q-${p.id}">0</b><button class="btn-qty" onclick="updateQty('${p.id}',1,${p.pre},'${p.nom}')">+</button></div></div>`;
        });
    });

    function updateQty(id, ch, pr, nom) {
        if(!carrito[id]) carrito[id] = { cant: 0, nom: nom, pr: pr };
        carrito[id].cant = Math.max(0, carrito[id].cant + ch);
        document.getElementById('q-'+id).innerText = carrito[id].cant;
        let sub = 0; for(let k in carrito) sub += (carrito[k].cant * carrito[k].pr);
        if(sub > 0) {
            total = sub + envio;
            document.getElementById('desglose').innerText = `Subtotal: $${sub} + Env√≠o: $${envio}`;
            document.getElementById('total-txt').innerText = `$${total}.00`;
        } else { total = 0; document.getElementById('desglose').innerText = ""; document.getElementById('total-txt').innerText = `$0.00`; }
    }

    canal.subscribe('ajuste-tiempo', (m) => {
        const txt = `${m.data.min} - ${m.data.max}`;
        document.getElementById('tiempo-promo').innerText = txt;
        document.getElementById('t-final-tracking').innerText = txt;
    });

    const saved = JSON.parse(localStorage.getItem('current_order'));
    if(saved) {
        document.getElementById('pantalla-menu').classList.add('d-none');
        document.getElementById('pantalla-tracking').classList.remove('d-none');
        escucharStatus(saved.id);
    }

    function enviarPedido() {
        const nom = document.getElementById('nombre').value;
        const dir = document.getElementById('direccion').value;
        const pago = document.querySelector('input[name="pago"]:checked').value;
        if(!nom || !dir || total === 0) return alert("Faltan datos");
        
        let itemsAlimentos = ""; let itemsSnacks = "";
        for(let k in carrito) {
            if(carrito[k].cant > 0) {
                let area = "";
                menuData.forEach(cat => { if(cat.items.find(i => i.id === k)) area = cat.area; });
                const linea = `${carrito[k].cant} x ${carrito[k].nom}\n`;
