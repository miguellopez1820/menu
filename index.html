<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men√∫ - Dash Food</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        :root { --main: #06C167; }
        body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; padding-bottom: 180px; }
        .cat-title { font-weight: 800; font-size: 0.9rem; color: #888; text-transform: uppercase; margin-top: 20px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .product-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 10px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .product-info b { font-size: 1.1rem; display: block; }
        .qty-controls { display: flex; align-items: center; gap: 12px; background: #f0f0f0; border-radius: 10px; padding: 5px 10px; }
        .btn-qty { border: none; background: none; font-weight: bold; font-size: 1.2rem; color: var(--main); width: 25px; }
        .cart-footer { background: white; position: fixed; bottom: 0; width: 100%; max-width: 500px; padding: 20px; box-shadow: 0 -10px 30px rgba(0,0,0,0.1); border-radius: 30px 30px 0 0; left: 50%; transform: translateX(-50%); z-index: 1000; }
        .btn-order { background: var(--main); color: white; border: none; border-radius: 15px; padding: 15px; width: 100%; font-weight: bold; font-size: 1.1rem; box-shadow: 0 5px 15px rgba(6,193,103,0.3); }
        .tracking-step { border-left: 3px solid #eee; padding-left: 20px; margin-bottom: 20px; position: relative; }
        .tracking-step.active { border-left-color: var(--main); }
        .tracking-step.active::before { content: '‚úì'; position: absolute; left: -12px; top: 0; background: var(--main); color: white; width: 20px; height: 20px; border-radius: 50%; text-align: center; font-size: 12px; }
    </style>
</head>
<body class="d-flex justify-content-center">

    <div style="width: 100%; max-width: 500px;">
        <div id="pantalla-menu">
            <div class="p-4 bg-dark text-white text-center rounded-bottom shadow">
                <h2 class="fw-bold mb-0">Dash Food üçî</h2>
                <div class="badge bg-success mt-2">‚è≥ 45 - 55 MIN</div>
            </div>

            <div id="menu-items" class="p-3">
                </div>

            <div class="p-3 bg-white mx-3 rounded-4 shadow-sm mb-4">
                <h6 class="fw-bold mb-3">Tus Datos:</h6>
                <input type="text" id="nombre" class="form-control mb-2 rounded-3" placeholder="Tu nombre">
                <textarea id="direccion" class="form-control mb-3 rounded-3" placeholder="Direcci√≥n completa y referencias"></textarea>
                
                <h6 class="fw-bold mb-2">M√©todo de Pago:</h6>
                <div class="d-flex gap-2">
                    <input type="radio" class="btn-check" name="pago" id="p_ef" value="Efectivo" checked>
                    <label class="btn btn-outline-dark w-100 rounded-3" for="p_ef">üíµ Efectivo</label>
                    <input type="radio" class="btn-check" name="pago" id="p_tar" value="Tarjeta">
                    <label class="btn btn-outline-dark w-100 rounded-3" for="p_tar">üí≥ Tarjeta</label>
                </div>
            </div>

            <div class="cart-footer">
                <div class="d-flex justify-content-between mb-2 px-2">
                    <span class="text-muted">Env√≠o domicilio:</span>
                    <span class="fw-bold text-dark">$15.00</span>
                </div>
                <div class="d-flex justify-content-between mb-3 px-2">
                    <span class="h5 fw-bold">Total:</span>
                    <span id="total-txt" class="h4 fw-bold text-success">$0.00</span>
                </div>
                <button id="btn-ordenar" onclick="enviarPedido()" class="btn-order">REALIZAR PEDIDO</button>
            </div>
        </div>

        <div id="pantalla-tracking" class="p-4 d-none">
            <div class="text-center mb-4">
                <h1 class="fw-bold">Pedido #<span id="folio-display">--</span></h1>
                <p class="text-muted">No cierres esta ventana para ver el progreso.</p>
            </div>
            <div class="tracking-container">
                <div id="st-1" class="tracking-step active"><b>Pedido Recibido</b><br><small>Estamos procesando tu orden.</small></div>
                <div id="st-2" class="tracking-step"><b>En Cocina</b><br><small>Tus alimentos se est√°n preparando.</small></div>
                <div id="st-3" class="tracking-step"><b>En Camino</b><br><small>El repartidor va hacia tu casa.</small></div>
                <div id="st-4" class="tracking-step"><b>Entregado</b><br><small>¬°Que disfrutes tu comida!</small></div>
            </div>
            <hr>
            <a href="https://wa.me/3316275115" class="btn btn-outline-dark w-100 py-3 rounded-4 fw-bold">WhatsApp Ayuda 3316275115</a>
        </div>
    </div>

<script>
    const ably = new Ably.Realtime('DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA');
    const canal = ably.channels.get('pedidos-menu');

    // CONFIGURACI√ìN DE TU MEN√ö
    const menu = [
        { cat: "Platillos Fuertes", area: "Alimentos", items: [
            {id: "h1", nom: "Hamb. Hawaiana", pre: 135},
            {id: "h2", nom: "Hamb. BBQ Doble", pre: 155},
            {id: "t1", nom: "Orden de Tacos", pre: 120}
        ]},
        { cat: "Snacks y Postres", area: "Snacks", items: [
            {id: "a1", nom: "Alitas 10 pz", pre: 160},
            {id: "b1", nom: "Bionico Grande", pre: 65},
            {id: "p1", nom: "Papas Fritas", pre: 55}
        ]}
    ];

    let carrito = {}; let totalVenta = 0; let costoEnvio = 15;

    // Renderizar Men√∫
    const menuCont = document.getElementById('menu-items');
    menu.forEach(seccion => {
        menuCont.innerHTML += `<div class="cat-title">${seccion.cat}</div>`;
        seccion.items.forEach(p => {
            menuCont.innerHTML += `
                <div class="product-card">
                    <div class="product-info">
                        <b>${p.nom}</b>
                        <small class="text-success fw-bold">$${p.pre}.00</small>
                    </div>
                    <div class="qty-controls">
                        <button class="btn-qty" onclick="changeQty('${p.id}', -1, ${p.pre}, '${p.nom}', '${seccion.area}')">-</button>
                        <span id="qty-${p.id}" class="fw-bold">0</span>
                        <button class="btn-qty" onclick="changeQty('${p.id}', 1, ${p.pre}, '${p.nom}', '${seccion.area}')">+</button>
                    </div>
                </div>`;
        });
    });

    function changeQty(id, delta, precio, nombre, area) {
        if (!carrito[id]) carrito[id] = { cant: 0, nom: nombre, pre: precio, area: area };
        carrito[id].cant = Math.max(0, carrito[id].cant + delta);
        document.getElementById(`qty-${id}`).innerText = carrito[id].cant;
        
        // Calcular Total
        let subtotal = 0;
        for (let k in carrito) subtotal += (carrito[k].cant * carrito[k].pre);
        
        if (subtotal > 0) {
            totalVenta = subtotal + costoEnvio;
            document.getElementById('total-txt').innerText = `$${totalVenta}.00`;
        } else {
            totalVenta = 0;
            document.getElementById('total-txt').innerText = `$0.00`;
        }
    }

    function enviarPedido() {
        const nom = document.getElementById('nombre').value;
        const dir = document.getElementById('direccion').value;
        const pago = document.querySelector('input[name="pago"]:checked').value;

        if (!nom || !dir || totalVenta === 0) return alert("Por favor selecciona productos y llena tus datos.");

        let alimStr = ""; let snkStr = "";
        for (let k in carrito) {
            if (carrito[k].cant > 0) {
                const linea = `${carrito[k].cant} x ${carrito[k].nom}\n`;
                if (carrito[k].area === "Alimentos") alimStr += linea;
                else snkStr += linea;
            }
        }

        document.getElementById('btn-ordenar').innerText = "Enviando...";
        document.getElementById('btn-ordenar').disabled = true;

        navigator.geolocation.getCurrentPosition((pos) => {
            const id = Date.now();
            const data = {
                id, creado: id, nombre: nom, total: totalVenta,
                alimentos: alimStr, snacks: snkStr, direccion: dir, pago,
                gps: `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`
            };

            localStorage.setItem('current_order', JSON.stringify(data));
            canal.publish('nuevo', data, () => {
                location.reload(); // Recargar para activar tracking
            });
        }, () => alert("Debes activar el GPS para ordenar."));
    }

    // Persistencia del Tracking
    const saved = JSON.parse(localStorage.getItem('current_order'));
    if (saved) {
        document.getElementById('pantalla-menu').classList.add('d-none');
        document.getElementById('pantalla-tracking').classList.remove('d-none');
        escucharStatus(saved.id);
    }

    function escucharStatus(id) {
        canal.subscribe('status-' + id, (m) => {
            const s = m.data;
            if (s.folio) document.getElementById('folio-display').innerText = s.folio;
            if (s.estado === 'cocinando') document.getElementById('st-2').classList.add('active');
            if (s.estado === 'camino') { document.getElementById('st-2').classList.add('active'); document.getElementById('st-3').classList.add('active'); }
            if (s.estado === 'entregado') {
                document.getElementById('st-4').classList.add('active');
                setTimeout(() => { localStorage.removeItem('current_order'); location.reload(); }, 5000);
            }
        });
    }
</script>
</body>
</html>
