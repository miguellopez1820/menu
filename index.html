<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dash Food - Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        :root { --main-green: #06C167; }
        body { background: #fdfdfd; font-family: 'Segoe UI', sans-serif; }
        .app-header { background: #000; color: #fff; padding: 20px; border-radius: 0 0 25px 25px; }
        .product-card { background: #fff; border-radius: 20px; padding: 15px; margin-bottom: 12px; border: 1px solid #f0f0f0; transition: 0.3s; }
        .qty-btn { width: 32px; height: 32px; border-radius: 10px; border: 1px solid #ddd; background: #fff; font-weight: bold; }
        .footer-cart { background: #fff; border-top: 1px solid #eee; padding: 20px; position: fixed; bottom: 0; width: 100%; max-width: 500px; left: 50%; transform: translateX(-50%); border-radius: 25px 25px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
        .btn-confirm { background: var(--main-green); color: #fff; border: none; border-radius: 15px; padding: 15px; width: 100%; font-weight: bold; }
        /* Tracking Steps */
        .step { padding-left: 45px; margin-bottom: 25px; position: relative; color: #bbb; transition: 0.5s; }
        .step::before { content: ""; position: absolute; left: 16px; top: 0; bottom: -25px; width: 2px; background: #eee; }
        .step:last-child::before { display: none; }
        .dot { position: absolute; left: 0; width: 34px; height: 34px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2; transition: 0.5s; }
        .active { color: #000; font-weight: bold; }
        .active .dot { background: var(--main-green); color: white; box-shadow: 0 0 15px rgba(6,193,103,0.4); }
    </style>
</head>
<body class="d-flex justify-content-center">
    <div style="width: 100%; max-width: 500px; padding-bottom: 150px;">
        <div id="pantalla-menu">
            <div class="app-header text-center shadow">
                <h2 class="fw-bold mb-0">Dash Food üçî</h2>
                <small class="opacity-50">Calidad en cada bocado</small>
            </div>
            <div class="p-3">
                <div class="product-card d-flex justify-content-between align-items-center shadow-sm">
                    <div><b>Hamburguesa Cl√°sica</b><br><span class="text-muted small">$120.00</span></div>
                    <div class="d-flex align-items-center gap-2">
                        <button class="qty-btn" onclick="updateQty('hamb', -1, 120)">-</button>
                        <b id="q-hamb">0</b>
                        <button class="qty-btn" onclick="updateQty('hamb', 1, 120)">+</button>
                    </div>
                </div>
                <div class="product-card d-flex justify-content-between align-items-center shadow-sm">
                    <div><b>Pizza Pepperoni</b><br><span class="text-muted small">$150.00</span></div>
                    <div class="d-flex align-items-center gap-2">
                        <button class="qty-btn" onclick="updateQty('piz', -1, 150)">-</button>
                        <b id="q-piz">0</b>
                        <button class="qty-btn" onclick="updateQty('piz', 1, 150)">+</button>
                    </div>
                </div>
                <div class="p-2">
                    <input type="text" id="nombre" class="form-control mb-2 rounded-3" placeholder="Tu nombre">
                    <textarea id="direccion" class="form-control mb-2 rounded-3" placeholder="Direcci√≥n de entrega"></textarea>
                    <textarea id="notas" class="form-control rounded-3" placeholder="Notas: Ej. Sin cebolla..."></textarea>
                </div>
            </div>
            <div class="footer-cart">
                <div class="d-flex justify-content-between mb-2 px-2"><b>Total:</b> <b id="total-txt">$0.00</b></div>
                <button onclick="enviar()" class="btn-confirm shadow">CONFIRMAR PEDIDO</button>
            </div>
        </div>

        <div id="pantalla-tracking" class="p-4 d-none text-center">
            <h3 class="fw-bold mb-4">Orden #<span id="folio-num">--</span></h3>
            <div class="text-start">
                <div id="st-1" class="step active"><div class="dot">üì©</div> Pedido recibido</div>
                <div id="st-2" class="step"><div class="dot">üî•</div> En cocina</div>
                <div id="st-3" class="step"><div class="dot">üõµ</div> En camino</div>
                <div id="st-4" class="step"><div class="dot">‚úÖ</div> ¬°Entregado!</div>
            </div>
            <a id="wa-link" href="#" target="_blank" class="btn btn-success w-100 rounded-4 mt-4 py-3 fw-bold">Ayuda por WhatsApp üí¨</a>
        </div>
    </div>

<script>
    const ably = new Ably.Realtime('DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA');
    const canal = ably.channels.get('pedidos-dash');
    let cart = { hamb: 0, piz: 0 }; let total = 0;

    function updateQty(id, change, price) {
        cart[id] = Math.max(0, cart[id] + change);
        document.getElementById(`q-${id}`).innerText = cart[id];
        total = (cart.hamb * 120) + (cart.piz * 150);
        document.getElementById('total-txt').innerText = `$${total}.00`;
    }

    function enviar() {
        const nombre = document.getElementById('nombre').value;
        if(!nombre || total === 0) return alert("Completa tu pedido");
        
        navigator.geolocation.getCurrentPosition((pos) => {
            const id = Date.now();
            const orderData = {
                id, nombre, total, 
                comida: `${cart.hamb > 0 ? cart.hamb+' Hamb ' : ''}${cart.piz > 0 ? cart.piz+' Pizza' : ''}`,
                direccion: document.getElementById('direccion').value,
                notas: document.getElementById('notas').value,
                gps: `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`
            };
            canal.publish('nuevo', orderData);
            document.getElementById('pantalla-menu').classList.add('d-none');
            document.getElementById('pantalla-tracking').classList.remove('d-none');

            canal.subscribe('status-' + id, (m) => {
                const s = m.data;
                if(s.folio) {
                    document.getElementById('folio-num').innerText = s.folio;
                    document.getElementById('wa-link').href = `https://wa.me/521234567890?text=Ayuda Folio #${s.folio}`;
                }
                if(s.estado === 'cocinando') document.getElementById('st-2').classList.add('active');
                if(s.estado === 'camino') { document.getElementById('st-2').classList.add('active'); document.getElementById('st-3').classList.add('active'); }
                if(s.estado === 'entregado') document.getElementById('st-4').classList.add('active');
            });
        });
    }
</script>
</body>
</html>
