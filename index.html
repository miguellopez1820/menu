<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taquer√≠a Leo | Pedidos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        :root { --leo-orange: #FF6600; --leo-green: #28a745; }
        body { background-color: #f8f9fa; font-family: 'Arial Black', sans-serif; }
        
        .header-logo { background: white; border-bottom: 6px solid var(--leo-orange); padding: 15px; text-align: center; }
        .logo-img { width: 100px; border-radius: 50%; border: 4px solid var(--leo-orange); }

        /* Botones de Productos */
        .btn-producto { height: 110px; font-size: 1.6rem; border-radius: 25px; border: 4px solid #ddd; background: white; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; margin-bottom: 15px; }
        .btn-producto:active { background: #fff3e6; border-color: var(--leo-orange); transform: scale(0.96); }
        .btn-seleccionado { border-color: var(--leo-green) !important; background: #e8f5e9 !important; }
        .precio-tag { background: var(--leo-green); color: white; padding: 5px 20px; border-radius: 50px; }

        /* Formulario Senior-Friendly */
        .card-datos { background: white; border: 5px solid var(--leo-orange); border-radius: 35px; padding: 30px; }
        .input-leo { height: 80px; font-size: 1.6rem !important; border: 3px solid #ccc; border-radius: 15px; margin-bottom: 20px; font-weight: bold; }
        .label-senior { font-size: 1.5rem; color: #333; font-weight: bold; margin-bottom: 10px; display: block; }

        /* Pantalla de Confirmaci√≥n */
        .overlay-confirmar { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: none; padding: 25px; overflow-y: auto; }
        .ticket-resumen { background: #fff8f0; border: 4px dashed var(--leo-orange); border-radius: 25px; padding: 25px; font-size: 1.6rem; margin-bottom: 20px; }
        .btn-final { font-size: 2.2rem; padding: 25px; border-radius: 50px; font-weight: bold; width: 100%; border: none; }
    </style>
</head>
<body>

<div class="header-logo">
    <img src="https://i.ibb.co/vzG7Zz4/logo-leo.png" class="logo-img" alt="Logo Leo">
    <h1 class="fw-bold mt-2" style="color: var(--leo-orange)">TAQUER√çA LEO</h1>
    <p class="text-danger fw-bold m-0 fs-4">üïí Tiempo de entrega: 45 min</p>
</div>

<div class="container py-4" id="pantalla-menu" style="max-width: 650px;">
    <h2 class="fw-bold mb-3" style="color: var(--leo-orange)">1. TOCA TU COMIDA:</h2>
    <div id="lista-productos">
        <button class="btn-producto" id="b1" onclick="seleccionar('h','Orden Tacos', 100, 'b1')">
            <span>üåÆ TACOS</span> <span class="precio-tag">$100</span>
        </button>
        <button class="btn-producto" id="b2" onclick="seleccionar('h','Hamburguesa', 120, 'b2')">
            <span>üçî HAMBURGUESA</span> <span class="precio-tag">$120</span>
        </button>
        <button class="btn-producto" id="b3" onclick="seleccionar('s','Alitas BBQ', 140, 'b3')">
            <span>üçó ALITAS</span> <span class="precio-tag">$140</span>
        </button>
    </div>

    <div class="card-datos shadow-lg mt-4">
        <h2 class="fw-bold mb-4 text-center">2. TUS DATOS DE ENTREGA:</h2>
        
        <label class="label-senior">ESCRIBE TU NOMBRE:</label>
        <input type="text" id="nom" class="form-control input-leo" placeholder="Ej. Juan P√©rez">
        
        <label class="label-senior">TU DIRECCI√ìN (Calle, N√∫mero, Colonia):</label>
        <input type="text" id="dir" class="form-control input-leo" placeholder="Escribe aqu√≠ tu direcci√≥n">
        
        <div class="d-flex justify-content-between h1 fw-bold text-success my-4">
            <span>TOTAL:</span><span id="txt-total">$10</span>
        </div>
        <button class="btn-final text-white" style="background: var(--leo-green);" onclick="abrirComprobacion()">REVISAR PEDIDO ‚ûî</button>
    </div>
</div>

<div id="overlay-confirmar" class="overlay-confirmar">
    <h1 class="text-center fw-bold display-4" style="color: var(--leo-orange)">COMPROBAR DATOS</h1>
    
    <div class="ticket-resumen" id="ticket-final"></div>

    <label class="label-senior">NOTAS (Opcional):</label>
    <textarea id="notas" class="form-control mb-4 fs-3" placeholder="Ej. Sin cebolla, port√≥n negro..." style="height: 120px;"></textarea>

    <label class="label-senior">¬øC√ìMO PAGAR√ÅS?</label>
    <select id="metodo-pago" class="form-select mb-4" style="height: 80px; font-size: 1.8rem; border: 4px solid var(--leo-orange); font-weight: bold;">
        <option value="Efectivo">üíµ PAGAR√â EN EFECTIVO</option>
        <option value="Tarjeta">üí≥ PAGO CON TARJETA</option>
    </select>

    <div class="row g-3">
        <div class="col-6">
            <button class="btn btn-secondary btn-final py-3 fs-2 rounded-pill shadow" onclick="cerrarComprobacion()">‚¨Ö CORREGIR</button>
        </div>
        <div class="col-6">
            <button class="btn btn-success btn-final py-3 fs-2 rounded-pill shadow" onclick="enviarFinal()">CONFIRMAR ‚úÖ</button>
        </div>
    </div>
</div>

<div id="tracking" class="d-none text-center py-5">
    <h1 style="font-size: 8rem;">üõµ</h1>
    <h1 class="display-1 fw-bold text-success" id="f-display">#...</h1>
    <h2 class="display-3 fw-bold" id="s-display" style="color: var(--leo-orange)">¬°PEDIDO RECIBIDO!</h2>
    <p class="fs-2 text-muted mt-3">Estamos preparando tu orden.</p>
    <button class="btn btn-dark btn-lg mt-5 py-4 w-100 rounded-pill fs-2" onclick="localStorage.removeItem('sesion_leo'); location.reload();">HACER OTRO PEDIDO</button>
</div>

<script>
    const ably = new Ably.Realtime({ key: 'TU_KEY_DE_ABLY_AQUI' });
    const canal = ably.channels.get('canal-operativo-menu');
    
    let subtotal = 0, alim = "", snak = "", gpsCoords = "";

    // CAPTURA GPS AUTOM√ÅTICA (Respaldo silencioso)
    window.onload = () => {
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(p => {
                gpsCoords = `${p.coords.latitude},${p.coords.longitude}`;
            }, null, { enableHighAccuracy: true });
        }
    };

    function seleccionar(tipo, nombre, precio, btnId) {
        subtotal += precio;
        if(tipo === 'h') alim += `‚Ä¢ 1x ${nombre}\n`; else snak += `‚Ä¢ 1x ${nombre}\n`;
        document.getElementById(btnId).classList.add('btn-seleccionado');
        document.getElementById('txt-total').innerText = `$${subtotal + 10}`;
    }

    function abrirComprobacion() {
        const n = document.getElementById('nom').value;
        const d = document.getElementById('dir').value;
        if(!n || !d || subtotal === 0) return alert("Por favor selecciona tu comida y escribe tu nombre y direcci√≥n.");

        let ticket = `<b>NOMBRE:</b> ${n}<br><b>DIRECCI√ìN:</b> ${d}<br><hr>`;
        ticket += `<b>PEDIDO:</b><br>${alim.replace(/\n/g, '<br>')}${snak.replace(/\n/g, '<br>')}`;
        ticket += `<hr><span class="text-success h1 fw-bold">PAGAR√ÅS: $${subtotal + 10}</span>`;
        
        document.getElementById('ticket-final').innerHTML = ticket;
        document.getElementById('overlay-confirmar').style.display = 'block';
    }

    function cerrarComprobacion() { document.getElementById('overlay-confirmar').style.display = 'none'; }

    function enviarFinal() {
        const idPed = Date.now();
        const data = {
            id: idPed,
            nombre: document.getElementById('nom').value,
            direccion: document.getElementById('dir').value, // DIRECCI√ìN MANUAL
            gps: gpsCoords, // GPS AUTOM√ÅTICO (si existe)
            alimentos: alim,
            snacks: snak,
            notas: document.getElementById('notas').value,
            total: subtotal + 10,
            pago: document.getElementById('metodo-pago').value,
            presencial: false
        };

        canal.publish('nuevo-pedido', data, (err) => {
            if(!err) {
                localStorage.setItem('sesion_leo', JSON.stringify({ id: idPed, time: Date.now() }));
                location.reload();
            }
        });
    }

    const sesion = JSON.parse(localStorage.getItem('sesion_leo'));
    if(sesion && (Date.now() - sesion.time < 28800000)) {
        document.getElementById('pantalla-menu').classList.add('d-none');
        document.getElementById('tracking').classList.remove('d-none');
        canal.subscribe('folio-asignado', m => { if(m.data.id == sesion.id) document.getElementById('f-display').innerText = "Folio #" + m.data.folio; });
        canal.subscribe('status-'+sesion.id, m => { document.getElementById('s-display').innerText = m.data.estado.toUpperCase(); });
    }
</script>
</body>
</html>
