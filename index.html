<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men√∫ - Dash Food</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        :root { --main: #06C167; }
        body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; padding-bottom: 180px; }
        .product-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 10px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .btn-qty { border: none; background: #eee; font-weight: bold; color: var(--main); width: 30px; height: 30px; border-radius: 8px; }
        .cart-footer { background: white; position: fixed; bottom: 0; width: 100%; max-width: 500px; padding: 20px; box-shadow: 0 -10px 30px rgba(0,0,0,0.1); border-radius: 30px 30px 0 0; left: 50%; transform: translateX(-50%); z-index: 1000; }
        .btn-order { background: var(--main); color: white; border: none; border-radius: 15px; padding: 15px; width: 100%; font-weight: bold; }
        .d-none { display: none !important; }
    </style>
</head>
<body class="d-flex justify-content-center">
    <div style="width: 100%; max-width: 500px;">
        <div id="pantalla-menu">
            <div class="p-4 bg-dark text-white text-center rounded-bottom shadow">
                <h2 class="fw-bold m-0">Dash Food üçî</h2>
            </div>
            <div id="lista-productos" class="p-3"></div>
            <div class="p-3">
                <input type="text" id="nombre" class="form-control mb-2" placeholder="Tu Nombre">
                <textarea id="direccion" class="form-control mb-2" placeholder="Direcci√≥n y referencias"></textarea>
                <div class="d-flex gap-2 mb-3">
                    <input type="radio" name="pago" id="p1" value="Efectivo" checked> Efectivo
                    <input type="radio" name="pago" id="p2" value="Tarjeta"> Tarjeta
                </div>
            </div>
            <div class="cart-footer">
                <div class="d-flex justify-content-between mb-3 h5 fw-bold">
                    <span>Total (+ env√≠o):</span>
                    <span id="total-txt" class="text-success">$0.00</span>
                </div>
                <button id="btn-ordenar" onclick="enviarPedido()" class="btn-order shadow">REALIZAR PEDIDO</button>
            </div>
        </div>

        <div id="pantalla-tracking" class="p-4 d-none text-center">
            <h1 class="fw-bold mt-5">Pedido <span id="folio-display" class="text-success">...</span></h1>
            <p class="text-muted">Estado: <b id="status-txt">Recibido ‚úÖ</b></p>
            <div class="alert alert-info mt-4">No cierres esta ventana para ver el progreso.</div>
        </div>
    </div>

<script>
    const ably = new Ably.Realtime('DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA');
    const canal = ably.channels.get('pedidos-menu');

    const productos = [
        {id:"h1", nom:"Hamburguesa", pre:135, area:"Alimentos"},
        {id:"a1", nom:"Alitas BBQ", pre:160, area:"Snacks"},
        {id:"b1", nom:"Bionico", pre:65, area:"Snacks"}
    ];

    let carrito = {}; let totalVenta = 0;

    const cont = document.getElementById('lista-productos');
    productos.forEach(p => {
        cont.innerHTML += `
            <div class="product-card shadow-sm">
                <div><b>${p.nom}</b><br><small>$${p.pre}</small></div>
                <div class="d-flex align-items-center gap-2">
                    <button class="btn-qty" onclick="sumar('${p.id}', -1)">-</button>
                    <b id="qty-${p.id}">0</b>
                    <button class="btn-qty" onclick="sumar('${p.id}', 1)">+</button>
                </div>
            </div>`;
    });

    function sumar(id, cant) {
        if(!carrito[id]) carrito[id] = { cant: 0, p: productos.find(x=>x.id==id) };
        carrito[id].cant = Math.max(0, carrito[id].cant + cant);
        document.getElementById('qty-'+id).innerText = carrito[id].cant;
        
        let sub = 0; for(let k in carrito) sub += (carrito[k].cant * carrito[k].p.pre);
        totalVenta = sub > 0 ? sub + 15 : 0;
        document.getElementById('total-txt').innerText = `$${totalVenta}.00`;
    }

    function enviarPedido() {
        const nom = document.getElementById('nombre').value;
        const dir = document.getElementById('direccion').value;
        if(!nom || !dir || totalVenta == 0) return alert("Completa tus datos");

        let alim = ""; let snk = "";
        for(let k in carrito) {
            if(carrito[k].cant > 0) {
                const l = `${carrito[k].cant} x ${carrito[k].p.nom}\n`;
                if(carrito[k].p.area == "Alimentos") alim += l; else snk += l;
            }
        }

        const id = Date.now();
        const data = { id, creado: id, nombre: nom, total: totalVenta, alimentos: alim, snacks: snk, direccion: dir, pago: document.querySelector('input[name="pago"]:checked').value };
        
        localStorage.setItem('current_order', JSON.stringify(data));
        canal.publish('nuevo', data, () => { location.reload(); });
    }

    // Escuchar actualizaciones (Folio y Status)
    const saved = JSON.parse(localStorage.getItem('current_order'));
    if(saved) {
        document.getElementById('pantalla-menu').classList.add('d-none');
        document.getElementById('pantalla-tracking').classList.remove('d-none');
        
        // Recibir folio desde Despacho
        canal.subscribe('update-folio', (m) => {
            if(m.data.id == saved.id) document.getElementById('folio-display').innerText = "#" + m.data.folio;
        });

        canal.subscribe('status-' + saved.id, (m) => {
            document.getElementById('status-txt').innerText = m.data.estado.toUpperCase();
        });
    }
</script>
</body>
</html>
