<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taquer√≠a Leo | Pedidos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        :root { --leo-orange: #FF6600; --leo-green: #28a745; }
        body { background-color: #f4f4f4; font-family: 'Arial Black', sans-serif; }
        .header-logo { background: white; border-bottom: 6px solid var(--leo-orange); padding: 15px; text-align: center; }
        .logo-img { width: 100px; border-radius: 50%; border: 4px solid var(--leo-orange); }
        .btn-producto { height: 100px; font-size: 1.5rem; border-radius: 20px; border: 4px solid #ddd; background: white; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 25px; margin-bottom: 12px; }
        .btn-producto:active { background: #fff3e6; transform: scale(0.96); }
        .precio-tag { background: var(--leo-green); color: white; padding: 5px 15px; border-radius: 50px; }
        
        /* Pantalla de Confirmaci√≥n */
        .overlay-confirmar { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: none; padding: 20px; overflow-y: auto; }
        .resumen-ticket { background: #fff8f0; border: 3px dashed var(--leo-orange); border-radius: 20px; padding: 20px; font-size: 1.3rem; }
    </style>
</head>
<body>

<div class="header-logo">
    <img src="https://i.ibb.co/vzG7Zz4/logo-leo.png" class="logo-img" alt="Logo">
    <h1 class="fw-bold mt-2" style="color: var(--leo-orange)">TAQUER√çA LEO</h1>
    <p class="text-danger fw-bold m-0">Tiempo de entrega: 45 min üïí</p>
</div>

<div class="container py-4" id="pantalla-menu" style="max-width: 600px;">
    <h3 class="fw-bold" style="color: var(--leo-orange)">1. SELECCIONA TU COMIDA:</h3>
    <div class="mb-4">
        <button class="btn-producto" onclick="agregar('h','Orden Tacos',100)"><span>üåÆ TACOS</span> <span class="precio-tag">$100</span></button>
        <button class="btn-producto" onclick="agregar('h','Hamburguesa',120)"><span>üçî HAMBURGUESA</span> <span class="precio-tag">$120</span></button>
        <button class="btn-producto" onclick="agregar('s','Alitas BBQ',140)"><span>üçó ALITAS</span> <span class="precio-tag">$140</span></button>
        <button class="btn-producto" onclick="agregar('s','Papas Gajo',70)"><span>üçü PAPAS</span> <span class="precio-tag">$70</span></button>
    </div>

    <div class="card p-4 shadow-lg border-dark" style="border-radius: 25px; border-width: 4px;">
        <h3 class="fw-bold mb-3">2. TUS DATOS:</h3>
        <input type="text" id="nom" class="form-control form-control-lg mb-3" placeholder="ESCRIBE TU NOMBRE" style="height: 65px;">
        <input type="text" id="dir" class="form-control form-control-lg mb-3" placeholder="DIRECCI√ìN Y REFERENCIAS" style="height: 65px;">
        
        <div class="d-flex justify-content-between h1 fw-bold text-success mb-3">
            <span>TOTAL:</span><span id="tot-pantalla">$10</span>
        </div>
        <button class="btn btn-success w-100 py-3 fs-2 fw-bold rounded-pill" onclick="mostrarConfirmacion()">REVISAR PEDIDO ‚ûî</button>
    </div>
</div>

<div id="overlay-confirmar" class="overlay-confirmar">
    <h1 class="text-center fw-bold" style="color: var(--leo-orange)">REVISA TU PEDIDO</h1>
    <div class="resumen-ticket mb-4" id="ticket-final">
        </div>

    <h4 class="fw-bold">NOTAS PARA COCINA (Opcional):</h4>
    <textarea id="notas" class="form-control mb-4" placeholder="Ej: Sin cebolla, mucha salsa..." style="height: 100px; font-size: 1.2rem;"></textarea>

    <h4 class="fw-bold">M√âTODO DE PAGO:</h4>
    <select id="pago" class="form-select form-select-lg mb-4" style="height: 70px; border: 3px solid var(--leo-orange);">
        <option value="Efectivo">üíµ PAGAR√â EN EFECTIVO</option>
        <option value="Tarjeta">üí≥ PAGAR√â CON TARJETA (Traer Terminal)</option>
    </select>

    <div class="row g-2">
        <div class="col-6">
            <button class="btn btn-secondary w-100 py-4 fs-3 rounded-pill" onclick="cerrarConfirmacion()">‚¨Ö REGRESAR</button>
        </div>
        <div class="col-6">
            <button class="btn btn-success w-100 py-4 fs-3 rounded-pill fw-bold" onclick="enviarPedido()">PEDIR YA ‚úÖ</button>
        </div>
    </div>
</div>

<div id="tracking" class="d-none text-center py-5">
    <h1 style="font-size: 6rem;">üõµ</h1>
    <h1 class="display-1 fw-bold text-success" id="f-display">#...</h1>
    <h2 class="display-4 fw-bold" id="s-display">PREPARANDO...</h2>
    <button class="btn btn-dark btn-lg mt-5 py-4 w-75 rounded-pill" onclick="localStorage.removeItem('sesion_leo'); location.reload();">HACER OTRO PEDIDO</button>
</div>

<script>
    const ably = new Ably.Realtime({ key: 'TU_KEY_DE_ABLY_AQUI' });
    const canal = ably.channels.get('canal-operativo-menu');
    
    let subtotal = 0, alimentos = "", snacks = "", gps = "";

    // GPS Autom√°tico
    navigator.geolocation.getCurrentPosition(p => { 
        gps = `${p.coords.latitude},${p.coords.longitude}`; 
    });

    function agregar(tipo, nombre, precio) {
        subtotal += precio;
        if(tipo === 'h') alimentos += `‚Ä¢ 1x ${nombre}\n`;
        else snacks += `‚Ä¢ 1x ${nombre}\n`;
        document.getElementById('tot-pantalla').innerText = `$${subtotal + 10}`;
    }

    function mostrarConfirmacion() {
        const n = document.getElementById('nom').value;
        const d = document.getElementById('dir').value;
        if(!n || !d || subtotal === 0) return alert("Por favor selecciona comida y llena tus datos.");

        let resumen = `<b>CLIENTE:</b> ${n}<br><b>DIR:</b> ${d}<br><hr>`;
        resumen += `<b>PRODUCTOS:</b><br>${alimentos.replace(/\n/g, '<br>')}${snacks.replace(/\n/g, '<br>')}`;
        resumen += `<hr><b class="text-success fs-2">TOTAL A PAGAR: $${subtotal + 10}</b>`;
        
        document.getElementById('ticket-final').innerHTML = resumen;
        document.getElementById('overlay-confirmar').style.display = 'block';
    }

    function cerrarConfirmacion() {
        document.getElementById('overlay-confirmar').style.display = 'none';
    }

    function enviarPedido() {
        const idPedido = Date.now();
        const data = {
            id: idPedido,
            nombre: document.getElementById('nom').value,
            direccion: document.getElementById('dir').value,
            gps: gps,
            alimentos: alimentos,
            snacks: snacks,
            notas: document.getElementById('notas').value,
            total: subtotal + 10,
            pago: document.getElementById('pago').value,
            presencial: false
        };

        canal.publish('nuevo-pedido', data, (err) => {
            if(err) {
                alert("Error al enviar el pedido. Intenta de nuevo.");
            } else {
                localStorage.setItem('sesion_leo', JSON.stringify({ id: idPedido, time: Date.now() }));
                location.reload();
            }
        });
    }

    // L√≥gica para mostrar rastreo si hay sesi√≥n activa
    const s = JSON.parse(localStorage.getItem('sesion_leo'));
    if(s && (Date.now() - s.time < 8*60*60*1000)) {
        document.getElementById('pantalla-menu').classList.add('d-none');
        document.getElementById('tracking').classList.remove('d-none');
        canal.subscribe('folio-asignado', m => { if(m.data.id == s.id) document.getElementById('f-display').innerText = "#" + m.data.folio; });
        canal.subscribe('status-'+s.id, m => { document.getElementById('s-display').innerText = m.data.estado.toUpperCase(); });
    }
</script>
</body>
</html>
