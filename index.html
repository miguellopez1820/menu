<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dash Food - Men√∫</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        :root { --main-green: #06C167; }
        body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; padding-bottom: 180px; }
        .cat-header { background: #000; color: #fff; padding: 5px 15px; border-radius: 10px; display: inline-block; margin: 15px 0 10px; font-size: 0.8rem; text-transform: uppercase; }
        .product-card { background: #fff; border-radius: 15px; padding: 12px; margin-bottom: 8px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .btn-qty { width: 32px; height: 32px; border-radius: 8px; border: 1px solid #ddd; background: #fff; font-weight: bold; }
        .cart-footer { background: #fff; position: fixed; bottom: 0; width: 100%; max-width: 500px; padding: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); border-radius: 25px 25px 0 0; left: 50%; transform: translateX(-50%); z-index: 100; }
        .btn-confirm { background: var(--main-green); color: #fff; border: none; border-radius: 12px; padding: 15px; width: 100%; font-weight: bold; }
        .step { padding-left: 35px; margin-bottom: 20px; position: relative; color: #ccc; }
        .step.active { color: #000; font-weight: bold; }
        .dot { position: absolute; left: 0; width: 22px; height: 22px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; }
        .active .dot { background: var(--main-green); color: white; }
    </style>
</head>
<body class="d-flex justify-content-center">
    <div style="width: 100%; max-width: 500px;">
        <div id="pantalla-menu">
            <div class="p-4 bg-dark text-white text-center shadow rounded-bottom">
                <h2 class="fw-bold mb-0">Dash Food üçî</h2>
                <small class="opacity-75">Ordena y rastrea tu pedido</small>
            </div>
            <div id="contenedor-menu" class="p-3"></div>
            <div class="p-3">
                <input type="text" id="nombre" class="form-control mb-2" placeholder="Tu nombre">
                <textarea id="direccion" class="form-control mb-2" placeholder="Direcci√≥n completa"></textarea>
            </div>
            <div class="cart-footer">
                <div id="desglose" class="small text-muted mb-1 px-1"></div>
                <div class="d-flex justify-content-between mb-3 px-1"><b>Total:</b> <b id="total-txt" class="text-success fs-5">$0.00</b></div>
                <button id="btn-ordenar" onclick="enviarPedido()" class="btn-confirm shadow">ORDENAR AHORA</button>
            </div>
        </div>

        <div id="pantalla-tracking" class="p-4 d-none text-center">
            <h2 class="fw-bold">Orden #<span id="folio-display">--</span></h2>
            <div class="text-start mt-4">
                <div id="st-1" class="step active"><div class="dot">1</div> Pedido Recibido ‚úÖ</div>
                <div id="st-2" class="step"><div class="dot">2</div> Preparando en Cocina üî•</div>
                <div id="st-3" class="step"><div class="dot">3</div> En Camino üõµ</div>
                <div id="st-4" class="step"><div class="dot">4</div> Entregado ‚úÖ</div>
            </div>
            <a id="btn-ayuda" href="#" target="_blank" class="btn btn-success w-100 mt-4 py-3 fw-bold rounded-4 shadow-sm">Ayuda por WhatsApp üí¨</a>
        </div>
    </div>

<script>
    const ably = new Ably.Realtime('DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA');
    const canal = ably.channels.get('pedidos-dash');

    const menuData = [
        { cat: "Hamburguesas", items: [
            { id: "h1", nom: "Hawaiana Especial", pre: 135 }, { id: "h2", nom: "BBQ Doble", pre: 155 }, { id: "h3", nom: "Mexicana Picosa", pre: 145 }
        ]},
        { cat: "Alitas", items: [
            { id: "a1", nom: "Mango Habanero", pre: 165 }, { id: "a2", nom: "BBQ Ahumada", pre: 160 }, { id: "a3", nom: "Buffalo Hot", pre: 160 }
        ]}
    ];

    let carrito = {}; let total = 0; let envio = 15;
    const cont = document.getElementById('contenedor-menu');
    menuData.forEach(s => {
        cont.innerHTML += `<div class="cat-header">${s.cat}</div>`;
        s.items.forEach(p => {
            cont.innerHTML += `<div class="product-card"><div><b>${p.nom}</b><br><small>$${p.pre}</small></div><div class="d-flex align-items-center gap-2"><button class="btn-qty" onclick="updateQty('${p.id}',-1,${p.pre},'${p.nom}')">-</button><b id="q-${p.id}">0</b><button class="btn-qty" onclick="updateQty('${p.id}',1,${p.pre},'${p.nom}')">+</button></div></div>`;
        });
    });

    function updateQty(id, ch, pr, nom) {
        if(!carrito[id]) carrito[id] = { cant: 0, nom: nom, pr: pr };
        carrito[id].cant = Math.max(0, carrito[id].cant + ch);
        document.getElementById('q-'+id).innerText = carrito[id].cant;
        
        let subtotal = 0;
        for(let k in carrito) subtotal += (carrito[k].cant * carrito[k].pr);
        
        if(subtotal > 0) {
            total = subtotal + envio;
            document.getElementById('desglose').innerText = `Subtotal: $${subtotal} + Env√≠o: $${envio}`;
            document.getElementById('total-txt').innerText = `$${total}.00`;
        } else {
            total = 0;
            document.getElementById('desglose').innerText = "";
            document.getElementById('total-txt').innerText = `$0.00`;
        }
    }

    const savedOrder = JSON.parse(localStorage.getItem('current_order'));
    if(savedOrder) {
        document.getElementById('pantalla-menu').classList.add('d-none');
        document.getElementById('pantalla-tracking').classList.remove('d-none');
        escucharStatus(savedOrder.id);
    }

    function enviarPedido() {
        const nom = document.getElementById('nombre').value;
        if(!nom || total === 0) return alert("Selecciona productos y nombre");
        document.getElementById('btn-ordenar').disabled = true;

        navigator.geolocation.getCurrentPosition((pos) => {
            const id = Date.now();
            let lista = ""; for(let k in carrito) if(carrito[k].cant > 0) lista += `${carrito[k].cant}x ${carrito[k].nom}, `;
            const data = { id, nombre: nom, total, comida: lista, direccion: document.getElementById('direccion').value, gps: `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}` };
            
            localStorage.setItem('current_order', JSON.stringify(data));
            canal.publish('nuevo', data, () => { location.reload(); });
        });
    }

    function escucharStatus(id) {
        canal.subscribe('status-' + id, (m) => {
            const s = m.data;
            if(s.folio) document.getElementById('folio-display').innerText = s.folio;
            if(s.estado === 'cocinando') document.getElementById('st-2').classList.add('active');
            if(s.estado === 'camino') { document.getElementById('st-2').classList.add('active'); document.getElementById('st-3').classList.add('active'); }
            if(s.estado === 'entregado') { document.getElementById('st-4').classList.add('active'); localStorage.removeItem('current_order'); }
        });
    }
</script>
</body>
</html>
