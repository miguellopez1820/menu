<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dash Food - Pedido en Vivo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        :root { --uber-green: #06C167; }
        body { background: #f7f7f7; font-family: 'Segoe UI', sans-serif; color: #333; }
        .app-card { border-radius: 20px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: white; }
        .btn-order { background: #000; color: #fff; border-radius: 12px; padding: 18px; width: 100%; font-weight: bold; border: none; transition: 0.3s; font-size: 1.1rem; }
        .btn-order:disabled { background: #555; }
        
        /* Seguimiento de Pasos */
        .step { position: relative; padding-left: 50px; margin-bottom: 40px; color: #ccc; transition: 0.4s; }
        .step::before { content: ""; position: absolute; left: 18px; top: 0; bottom: -40px; width: 2px; background: #eee; }
        .step:last-child::before { display: none; }
        .step-icon { position: absolute; left: 0; width: 38px; height: 38px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1; transition: 0.4s; }
        .active { color: #000; font-weight: bold; }
        .active .step-icon { background: var(--uber-green); color: white; }
    </style>
</head>
<body>

<div id="pantalla-pedido" class="container py-4">
    <header class="text-center mb-4">
        <h2 class="fw-bold">Dash Food üçî</h2>
        <p class="text-muted">Tu comida favorita a un clic</p>
    </header>

    <div class="card app-card p-4 shadow mb-4">
        <div class="mb-3">
            <label class="fw-bold small mb-1">Tu Nombre:</label>
            <input type="text" id="nombre" class="form-control" placeholder="¬øA nombre de qui√©n?">
        </div>
        
        <div class="mb-3">
            <label class="fw-bold small mb-1">Selecciona tu Orden:</label>
            <select id="comida" class="form-select">
                <option value="Hamburguesa Especial - $120">Hamburguesa Especial - $120</option>
                <option value="Pizza Pepperoni - $150">Pizza Pepperoni - $150</option>
                <option value="Alitas BBQ - $130">Alitas BBQ - $130</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="fw-bold small mb-1 text-primary">Especificaciones (Opcional):</label>
            <textarea id="especificaciones" class="form-control" rows="2" placeholder="Ej: Sin cebolla, extra salsa..."></textarea>
        </div>

        <div class="mb-4">
            <label class="fw-bold small mb-1">Direcci√≥n Escrita:</label>
            <textarea id="direccion" class="form-control" rows="2" placeholder="Calle, n√∫mero y colonia"></textarea>
        </div>
        
        <button onclick="enviarPedido()" class="btn-order shadow">CONFIRMAR PEDIDO üìç</button>
        <p class="text-center small text-muted mt-3">Necesitamos tu GPS para que el repartidor llegue m√°s r√°pido.</p>
    </div>
</div>

<div id="pantalla-tracking" class="container py-5 d-none">
    <div class="card app-card p-4 text-center shadow-lg">
        <h4 class="fw-bold mb-5">Estado de tu pedido üõµ</h4>
        <div class="text-start ms-2">
            <div id="step1" class="step active"><div class="step-icon">üì©</div>Pedido Recibido</div>
            <div id="step2" class="step"><div class="step-icon">üî•</div>Preparando en Cocina</div>
            <div id="step3" class="step"><div class="step-icon">üõµ</div>Repartidor en Camino</div>
        </div>
    </div>
</div>

<script>
    const ably = new Ably.Realtime('DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA');
    const canal = ably.channels.get('pedidos-dash');
    let idPedido = "P-" + Math.floor(Math.random() * 10000);

    function enviarPedido() {
        const nombre = document.getElementById('nombre').value;
        const direccion = document.getElementById('direccion').value;
        
        if(!nombre || !direccion) {
            alert("Por favor, ingresa tu nombre y direcci√≥n.");
            return;
        }

        const btn = document.querySelector('.btn-order');
        btn.innerText = "LOCALIZANDO GPS... üïí";
        btn.disabled = true;

        // AQU√ç SE PIDE LA UBICACI√ìN AL HACER CLIC
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Formato de link corregido para evitar 404
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const gpsLink = `https://www.google.com/maps?q=${lat},${lon}`;
                    procesarEnvio(nombre, direccion, gpsLink);
                },
                (error) => {
                    alert("No pudimos obtener tu GPS. El pedido se enviar√° solo con la direcci√≥n escrita.");
                    procesarEnvio(nombre, direccion, "GPS no proporcionado");
                },
                { enableHighAccuracy: true, timeout: 8000 }
            );
        } else {
            procesarEnvio(nombre, direccion, "Navegador no soporta GPS");
        }
    }

    function procesarEnvio(nombre, direccion, gpsLink) {
        const datos = {
            id: idPedido,
            nombre: nombre,
            comida: document.getElementById('comida').value,
            notas: document.getElementById('especificaciones').value,
            direccion: direccion,
            gps: gpsLink
        };

        canal.publish('nuevo', datos);

        document.getElementById('pantalla-pedido').classList.add('d-none');
        document.getElementById('pantalla-tracking').classList.remove('d-none');

        canal.subscribe('status-' + idPedido, (msg) => {
            if(msg.data.estado === 'cocinando') document.getElementById('step2').classList.add('active');
            if(msg.data.estado === 'camino') {
                document.getElementById('step2').classList.add('active');
                document.getElementById('step3').classList.add('active');
            }
        });
    }
</script>

</body>
</html>
