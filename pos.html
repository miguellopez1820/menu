<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>POS Maestro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        body { background: #121212; color: white; display: flex; height: 100vh; overflow: hidden; }
        .menu-area { flex: 1; padding: 20px; overflow-y: auto; border-right: 1px solid #333; }
        .ticket-area { width: 350px; background: #1e1e1e; padding: 20px; }
        .btn-alim { background: #441111; border: 2px solid #ff4444; color: white; height: 70px; margin-bottom: 8px; border-radius: 10px; font-weight: bold; }
        .btn-snack { background: #443311; border: 2px solid #ffcc44; color: white; height: 70px; margin-bottom: 8px; border-radius: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="menu-area">
        <h5 class="text-danger">ALIMENTOS</h5>
        <div class="row g-2" id="grid-alim"></div>
        <h5 class="text-warning mt-4">SNACKS</h5>
        <div class="row g-2" id="grid-snack"></div>
    </div>
    <div class="ticket-area">
        <h4>TICKET</h4>
        <div id="lista-ticket" class="flex-grow-1 overflow-auto" style="min-height: 50vh;"></div>
        <input type="text" id="cliente" class="form-control mb-2 bg-dark text-white border-secondary" placeholder="Mesa/Nombre">
        <h2 class="text-success fw-bold" id="total-val">$0</h2>
        <button id="btn-env" class="btn btn-success w-100 py-3 fw-bold" onclick="mandar()">ENVIAR ðŸ”¥</button>
    </div>
    <div id="overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:9999;">
        <h1 style="font-size: 8rem;" class="text-success fw-bold" id="folio-num">--</h1>
        <button class="btn btn-light px-5 py-2" onclick="cerrar()">CONTINUAR</button>
    </div>

<script>
    const ably = new Ably.Realtime({ key: 'DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA' });
    const canal = ably.channels.get('canal-operativo-menu');
    const menu = [
        {id:"h1", nom:"Hamburguesa", pre:135, area:"Alimentos"},
        {id:"a1", nom:"Alitas", pre:160, area:"Snacks"},
        {id:"b1", nom:"Bionico", pre:65, area:"Snacks"}
    ];
    let cart = []; let total = 0; let ultimoId = 0;

    menu.filter(x=>x.area=="Alimentos").forEach(p => {
        document.getElementById('grid-alim').innerHTML += `<div class="col-6"><button class="btn btn-alim w-100" onclick="add('${p.id}')">${p.nom}</button></div>`;
    });
    menu.filter(x=>x.area=="Snacks").forEach(p => {
        document.getElementById('grid-snack').innerHTML += `<div class="col-6"><button class="btn btn-snack w-100" onclick="add('${p.id}')">${p.nom}</button></div>`;
    });

    function add(id) { const p = menu.find(x=>x.id==id); cart.push(p); render(); }
    function render() {
        const d = document.getElementById('lista-ticket'); d.innerHTML = ""; total = 0;
        cart.forEach((p,i) => { total+=p.pre; d.innerHTML+=`<div class="p-2 border-bottom border-secondary d-flex justify-content-between"><span>${p.nom}</span><b onclick="cart.splice(${i},1);render()" style="cursor:pointer">âœ•</b></div>`; });
        document.getElementById('total-val').innerText = `$${total}`;
    }

    function mandar() {
        if(!document.getElementById('cliente').value || cart.length==0) return alert("Faltan datos");
        ultimoId = Date.now();
        let al="", sn="";
        cart.forEach(p=>{ if(p.area=="Alimentos") al+=`1x ${p.nom}\n`; else sn+=`1x ${p.nom}\n`; });
        canal.publish('nuevo-pedido', { id: ultimoId, nombre: document.getElementById('cliente').value, alimentos: al, snacks: sn, total: total, presencial: true });
        document.getElementById('btn-env').innerText = "ESPERANDO FOLIO...";
    }

    canal.subscribe('folio-asignado', (m) => {
        if(m.data.id == ultimoId) {
            document.getElementById('folio-num').innerText = m.data.folio;
            document.getElementById('overlay').style.display = 'flex';
        }
    });

    function cerrar() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('btn-env').innerText = "ENVIAR ðŸ”¥";
        document.getElementById('cliente').value = ""; cart = []; render();
    }
</script>
</body>
</html>
