<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>KDS Cocina</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        body { background: #000; color: #fff; }
        .ticket-container { display: flex; gap: 20px; padding: 20px; overflow-x: auto; }
        .ticket { background: #fff; color: #000; min-width: 300px; border-radius: 8px; border-top: 10px solid #333; }
        .pedido-txt { font-size: 1.8rem; font-weight: 800; color: #d32f2f; }
        .timer-badge { font-family: monospace; font-size: 1.2rem; padding: 4px 10px; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="p-3 bg-dark d-flex justify-content-between align-items-center border-bottom border-warning">
        <h2 class="fw-bold text-warning m-0">üë®‚Äçüç≥ COCINA KDS</h2>
        <div id="reloj" class="fs-4">00:00:00</div>
    </div>
    <div id="lista-cocina" class="ticket-container"></div>
    <hr class="border-secondary">
    <div class="p-3"><h6 class="text-white-50">HISTORIAL DE SALIDAS (RECIENTES)</h6><div id="hist-cocina" class="d-flex gap-2"></div></div>
    <audio id="snd" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
    const ably = new Ably.Realtime('DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA');
    const canal = ably.channels.get('pedidos-dash');
    let activos = JSON.parse(localStorage.getItem('p_cocina')) || [];

    activos.forEach(p => dibujar(p));
    setInterval(() => { document.getElementById('reloj').innerText = new Date().toLocaleTimeString(); }, 1000);

    canal.subscribe('nuevo', (msg) => {
        const p = msg.data; if(activos.find(x => x.id == p.id)) return;
        activos.push(p); localStorage.setItem('p_cocina', JSON.stringify(activos));
        dibujar(p); document.getElementById('snd').play();
    });

    canal.subscribe('update-folio', (m) => {
        const el = document.getElementById(`fol-${m.data.id}`);
        if(el) el.innerText = "#" + m.data.folio;
    });

    function dibujar(p) {
        const div = document.createElement('div');
        div.id = `ticket-${p.id}`; div.className = "ticket shadow-lg";
        div.innerHTML = `
            <div class="p-2 d-flex justify-content-between align-items-center border-bottom">
                <span>FOLIO <b id="fol-${p.id}">---</b></span>
                <span id="t-${p.id}" class="timer-badge bg-light">00:00</span>
            </div>
            <div class="p-3">
                <div class="pedido-txt uppercase">${p.comida}</div>
                <div class="small fw-bold mt-2">PAGO: ${p.pago}</div>
                ${p.pago === 'Tarjeta' ? '<div class="badge bg-primary w-100 fs-6 mt-1">üí≥ LLEVAR TERMINAL</div>' : ''}
                <hr>
                <button class="btn btn-warning w-100 fw-bold" onclick="st('${p.id}','cocinando')">COCINAR üî•</button>
                <button class="btn btn-success w-100 mt-2 fw-bold" onclick="remover('${p.id}')">PEDIDO LISTO ‚úÖ</button>
            </div>`;
        document.getElementById('lista-cocina').prepend(div);
        iniciarT(p.id, p.creado);
    }

    function iniciarT(id, inicio) {
        const interval = setInterval(() => {
            const el = document.getElementById(`t-${id}`);
            if(!el) { clearInterval(interval); return; }
            const min = Math.floor((Date.now() - inicio) / 60000);
            const seg = Math.floor(((Date.now() - inicio) % 60000) / 1000);
            el.innerText = `${min}:${seg < 10 ? '0'+seg : seg}`;
            if(min < 20) el.className = "timer-badge bg-success text-white";
            else if(min < 35) el.className = "timer-badge bg-warning text-dark";
            else el.className = "timer-badge bg-danger text-white";
        }, 1000);
    }

    function st(id, s) { canal.publish('status-'+id, {estado: s}); }
    function remover(id) {
        const p = activos.find(x => x.id == id);
        const div = document.createElement('div'); div.className = "badge bg-secondary p-2";
        div.innerText = `#${p.folio || 'SN'} - ${p.comida}`;
        document.getElementById('hist-cocina').prepend(div);
        activos = activos.filter(x => x.id != id);
        localStorage.setItem('p_cocina', JSON.stringify(activos));
        document.getElementById('ticket-'+id).remove();
    }
</script>
</body>
</html>
