<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>COCINA - Dash Food</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; }
        .card-pedido { background: #111; border: 2px solid #333; border-radius: 15px; overflow: hidden; margin-bottom: 20px; }
        .barra-titulo { background: #222; padding: 10px; border-bottom: 2px solid #444; }
        .nombre-cliente { color: #00e5ff; font-size: 1.4rem; font-weight: bold; }
        .orden-texto { color: #fff; font-size: 1.8rem; line-height: 1.2; } /* Texto muy grande para cocina */
        .caja-notas { background: #332b00; border: 1px solid #ffd700; color: #ffd700; padding: 10px; border-radius: 8px; font-weight: bold; }
        .caja-direccion { background: #002b36; border: 1px solid #00e5ff; color: #00e5ff; padding: 10px; border-radius: 8px; font-weight: bold; margin-top: 10px; }
        .btn-accion { font-weight: bold; padding: 15px; border-radius: 10px; font-size: 1.1rem; }
    </style>
</head>
<body class="p-3">
    <h2 class="fw-bold mb-4">üë®‚Äçüç≥ PEDIDOS EN COCINA <span id="count" class="badge bg-danger">0</span></h2>
    <div id="lista-cocina" class="row g-3"></div>

    <audio id="alarma" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        const ably = new Ably.Realtime('DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA');
        const canal = ably.channels.get('pedidos-dash');
        const audio = document.getElementById('alarma');

        canal.subscribe('nuevo', (msg) => {
            const p = msg.data;
            audio.play().catch(e => {});
            
            const div = document.createElement('div');
            div.className = 'col-md-6 col-lg-4';
            div.id = `ped-${p.id}`;
            div.innerHTML = `
                <div class="card card-pedido shadow-lg">
                    <div class="barra-titulo d-flex justify-content-between">
                        <span class="nombre-cliente">${p.nombre}</span>
                        <span class="badge bg-warning text-dark fw-bold">NUEVO PEDIDO</span>
                    </div>
                    <div class="p-3">
                        <p class="orden-texto text-warning fw-bold">üì¶ ${p.comida}</p>
                        <div class="caja-notas mb-2 small">üìù NOTAS: ${p.notas || 'SIN CAMBIOS'}</div>
                        <div class="caja-direccion small">üè† DIRECCI√ìN:<br>${p.direccion}</div>
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-warning btn-accion w-100" onclick="update('${p.id}','cocinando')">üî• PREPARAR</button>
                            <button class="btn btn-primary btn-accion w-100" onclick="enviar('${p.id}', '${encodeURIComponent(JSON.stringify(p))}')">üõµ ENVIAR</button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('lista-cocina').prepend(div);
            actualizarContador(1);
        });

        function update(id, st) { canal.publish('status-'+id, {estado: st}); }
        
        function enviar(id, data) {
            const p = JSON.parse(decodeURIComponent(data));
            canal.publish('status-'+id, {estado: 'camino'});
            canal.publish('para-repartidor', p); 
            canal.publish('para-gerente', p);    
            document.getElementById(`ped-${id}`).remove();
            actualizarContador(-1);
        }

        function actualizarContador(n) {
            const b = document.getElementById('count');
            b.innerText = parseInt(b.innerText) + n;
        }
    </script>
</body>
</html>
