<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cocina - Dash Food</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>body{background:#000;color:#fff;}.order-box{background:#111;border:2px solid #333;border-radius:15px;margin-bottom:15px;}.comida-txt{font-size:2rem;color:#ffeb3b;font-weight:bold;}</style>
</head>
<body class="p-3">
    <h2 class="fw-bold mb-4">üë®‚Äçüç≥ COCINA</h2>
    <div id="lista-cocina"></div>
    <audio id="snd" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        const ably = new Ably.Realtime('DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA');
        const canal = ably.channels.get('pedidos-dash');

        let pedidos = JSON.parse(localStorage.getItem('p_cocina')) || [];
        pedidos.forEach(p => dibujar(p));

        canal.subscribe('nuevo', (msg) => {
            const p = msg.data;
            if(pedidos.find(x => x.id == p.id)) return;
            pedidos.push(p);
            localStorage.setItem('p_cocina', JSON.stringify(pedidos));
            dibujar(p);
            document.getElementById('snd').play();
        });

        canal.subscribe('update-folio', (m) => {
            const el = document.getElementById(`fol-${m.data.id}`);
            if(el) el.innerText = "#" + m.data.folio;
        });

        function dibujar(p) {
            const div = document.createElement('div');
            div.id = `c-${p.id}`; div.className = "order-box p-3";
            div.innerHTML = `
                <div class="d-flex justify-content-between"><h4>FOLIO: <span id="fol-${p.id}" class="text-danger">---</span></h4></div>
                <div class="comida-txt text-uppercase">${p.comida}</div>
                <div class="mt-2"><button class="btn btn-warning w-100 mb-2" onclick="st('${p.id}','cocinando')">EMPEZAR COCINA</button>
                <button class="btn btn-danger w-100" onclick="remover('${p.id}')">ENVIAR A DESPACHO</button></div>`;
            document.getElementById('lista-cocina').prepend(div);
        }

        function st(id, s) { canal.publish('status-'+id, {estado: s}); }
        function remover(id) {
            pedidos = pedidos.filter(x => x.id != id);
            localStorage.setItem('p_cocina', JSON.stringify(pedidos));
            document.getElementById('c-'+id).remove();
        }
    </script>
</body>
</html>
