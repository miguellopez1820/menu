<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gerencia | Taquer√≠a Leo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
</head>
<body class="bg-dark text-white p-4">
    <div class="d-flex justify-content-between mb-4">
        <h2 class="fw-bold">üìä AUDITOR√çA Y CORTE DIARIO</h2>
        <button class="btn btn-danger fw-bold" onclick="nuevoDia()">üåû INICIAR NUEVO D√çA (CORTE)</button>
    </div>

    <div class="row g-3 mb-4 text-dark text-center">
        <div class="col-md-3"><div class="card p-3 bg-white"><h6>Venta Local</h6><h2 id="v-loc">$0</h2></div></div>
        <div class="col-md-3"><div class="card p-3 bg-white"><h6>Venta Domicilio</h6><h2 id="v-dom">$0</h2></div></div>
        <div class="col-md-3"><div class="card p-3 bg-warning"><h6>Cancelados</h6><h2 id="v-can">0</h2></div></div>
        <div class="col-md-3"><div class="card p-3 bg-success text-white"><h6>CAJA TOTAL</h6><h2 id="v-total">$0</h2></div></div>
    </div>

    <div class="card text-dark p-3">
        <h5 class="fw-bold border-bottom pb-2">üìç RASTREO GPS Y TIEMPOS</h5>
        <div id="live-repas" class="mb-3 d-flex gap-2 flex-wrap"></div>
        
        <table class="table table-sm table-hover mt-3">
            <thead class="table-dark">
                <tr><th>Folio</th><th>Hora</th><th>Tipo</th><th>Chofer</th><th>Tiempo Entrega</th><th>Total</th><th>Estatus</th></tr>
            </thead>
            <tbody id="hist"></tbody>
        </table>
    </div>

<script>
    const ably = new Ably.Realtime({ key: 'DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA' });
    const canal = ably.channels.get('canal-operativo-menu');
    let data = JSON.parse(localStorage.getItem('g_data_v2')) || [];

    actualizar();

    // ESCUCHAR TODAS LAS VENTAS (Vienen de POS o Reparto)
    canal.subscribe('registro-gerente', m => {
        data.push(m.data);
        localStorage.setItem('g_data_v2', JSON.stringify(data));
        actualizar();
    });

    // ESCUCHAR GPS
    canal.subscribe('posicion-repa', m => {
        const { chofer, coords } = m.data;
        document.getElementById(`gps-${chofer}`)?.remove();
        document.getElementById('live-repas').innerHTML += `
            <div id="gps-${chofer}" class="badge bg-primary p-2">
                üõµ ${chofer}: <a href="https://www.google.com/maps?q=${coords}" target="_blank" class="text-white">VER MAPA</a>
            </div>`;
    });

    function actualizar() {
        const h = document.getElementById('hist'); h.innerHTML = "";
        let loc = 0, dom = 0, can = 0;

        data.forEach(p => {
            const min = p.horaFin ? Math.round((p.horaFin - p.id) / 60000) : '--';
            
            if(p.status !== 'cancelado') {
                if(p.presencial) loc += parseFloat(p.total); else dom += parseFloat(p.total);
            } else { can++; }
            
            h.innerHTML += `
                <tr class="${p.status=='cancelado'?'table-danger':''}">
                    <td>#${p.folio}</td>
                    <td>${new Date(p.id).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
                    <td>${p.presencial?'LOCAL':'DOM'}</td>
                    <td>${p.chofer_nombre || '--'}</td>
                    <td class="fw-bold">${min} min</td>
                    <td class="text-success fw-bold">$${p.total}</td>
                    <td>${p.status.toUpperCase()}</td>
                </tr>`;
        });

        document.getElementById('v-loc').innerText = `$${loc}`;
        document.getElementById('v-dom').innerText = `$${dom}`;
        document.getElementById('v-can').innerText = can;
        document.getElementById('v-total').innerText = `$${loc + dom}`;
    }

    function nuevoDia() {
        if(prompt("CLAVE DE GERENTE:") === "LEO2026") {
            localStorage.clear();
            location.reload();
        }
    }
</script>
</body>
</html>
