<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gerencia | Leo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
</head>
<body class="bg-dark text-white p-4">
    <div class="d-flex justify-content-between mb-4">
        <h2>üìä CONTROL GERENCIAL</h2>
        <button class="btn btn-danger" onclick="nuevoDia()">üåû CORTE Y NUEVO D√çA</button>
    </div>

    <div class="row g-3 mb-4 text-dark text-center">
        <div class="col-md-4"><div class="card p-3"><h6>Ventas Local</h6><h3 id="v-loc">$0</h3></div></div>
        <div class="col-md-4"><div class="card p-3"><h6>Ventas Dom</h6><h3 id="v-dom">$0</h3></div></div>
        <div class="col-md-4"><div class="card p-3 bg-warning"><h6>Cancelaciones</h6><h3 id="v-can">0</h3></div></div>
    </div>

    <div class="card p-3 text-dark">
        <h5>üìç Rastreo y Eficiencia</h5>
        <div id="live-repas" class="mb-3"></div>
        <table class="table">
            <thead><tr><th>Folio</th><th>Chofer</th><th>Tiempo</th><th>Total</th></tr></thead>
            <tbody id="hist"></tbody>
        </table>
    </div>

<script>
    const ably = new Ably.Realtime({ key: 'DTn3Xw.LRKcmg:kyc7qhpjvAETzWfzWTVNnLerapobqPaCivYdBVk97OA' });
    const canal = ably.channels.get('canal-operativo-menu');
    let data = JSON.parse(localStorage.getItem('g_data')) || [];

    actualizar();

    canal.subscribe('registro-gerente', m => { data.push(m.data); localStorage.setItem('g_data', JSON.stringify(data)); actualizar(); });
    
    canal.subscribe('posicion-repa', m => {
        const { chofer, coords } = m.data;
        document.getElementById(`gps-${chofer}`)?.remove();
        document.getElementById('live-repas').innerHTML += `<div id="gps-${chofer}" class="badge bg-primary m-1">üìç ${chofer}: <a href="https://www.google.com/maps?q=${coords}" target="_blank" class="text-white">Ver Mapa</a></div>`;
    });

    function actualizar() {
        const h = document.getElementById('hist'); h.innerHTML = "";
        let l=0, d=0, c=0;
        data.forEach(p => {
            const min = Math.round((Date.now() - p.id)/60000);
            if(p.status !== 'cancelado') {
                if(p.presencial) l += parseFloat(p.total); else d += parseFloat(p.total);
                h.innerHTML += `<tr><td>#${p.folio}</td><td>${p.chofer_nombre||'--'}</td><td>${min} min</td><td>$${p.total}</td></tr>`;
            } else c++;
        });
        document.getElementById('v-loc').innerText = `$${l}`; document.getElementById('v-dom').innerText = `$${d}`; document.getElementById('v-can').innerText = c;
    }

    function nuevoDia() {
        if(prompt("CLAVE:") === "LEO2026") { localStorage.clear(); location.reload(); }
    }
</script>
</body>
</html>
